"use strict";L.CanvasOverlay=L.Class.extend({initialize:function(n,t){this._userDrawFunc=n,L.setOptions(this,t)},drawing:function(n){return this._userDrawFunc=n,this},params:function(n){return L.setOptions(this,n),this},canvas:function(){return this._canvas},redraw:function(){return this._frame||(this._frame=L.Util.requestAnimFrame(this._redraw,this)),this},onAdd:function(n){this._map=n,this._canvas=L.DomUtil.create("canvas","leaflet-heatmap-layer");var t=this._map.getSize();this._canvas.width=t.x,this._canvas.height=t.y;var e=this._map.options.zoomAnimation&&L.Browser.any3d;L.DomUtil.addClass(this._canvas,"leaflet-zoom-"+(e?"animated":"hide")),n._panes.overlayPane.appendChild(this._canvas),n.on("moveend",this._reset,this),n.on("resize",this._resize,this),n.options.zoomAnimation&&L.Browser.any3d&&n.on("zoomanim",this._animateZoom,this),this._reset()},onRemove:function(n){n.getPanes().overlayPane.removeChild(this._canvas),n.off("moveend",this._reset,this),n.off("resize",this._resize,this),n.options.zoomAnimation&&n.off("zoomanim",this._animateZoom,this)},addTo:function(n){return n.addLayer(this),this},_resize:function(n){this._canvas.width=n.newSize.x,this._canvas.height=n.newSize.y},_reset:function(){var n=this._map.containerPointToLayerPoint([0,0]);L.DomUtil.setPosition(this._canvas,n),this._redraw()},_redraw:function(){var n=this._map.getSize(),t=this._map.getBounds(),e=180*n.x/(20037508.34*(t.getEast()-t.getWest())),i=this._map.getZoom();this._userDrawFunc&&this._userDrawFunc(this,{canvas:this._canvas,bounds:t,size:n,zoomScale:e,zoom:i,options:this.options}),this._frame=null},_animateZoom:function(n){var t=this._map.getZoomScale(n.zoom),e=this._map._getCenterOffset(n.center)._multiplyBy(-t).subtract(this._map._getMapPanePos());this._canvas.style[L.DomUtil.TRANSFORM]=L.DomUtil.getTranslateString(e)+" scale("+t+")"}}),L.canvasOverlay=function(n,t){return new L.CanvasOverlay(n,t)};var Windy=function(n){var t,e,i,o,a,r,s,l,d,u,c,h=.005*(Math.pow(window.devicePixelRatio,1/3)||1),p=261.15,m=317.15,f=90,v=1,w=.005,g=Math.pow(window.devicePixelRatio,1/3)||1.6,S=15,W=1e3/S,y=[NaN,NaN,null],M=function(n,t,e,i,o,a){var r=1-n,s=1-t,l=r*s,d=n*s,u=r*t,c=n*t,h=e[0]*l+i[0]*d+o[0]*u+a[0]*c,p=e[1]*l+i[1]*d+o[1]*u+a[1]*c,m=e[2]*l+i[2]*d+o[2]*u+a[2]*c;return[h,p,m]},H=function(n,t,e){var i=n.data,o=t.data;return{header:n.header,data:function(n){return[i[n],o[n],e.data[n]]},interpolate:M}},J=function(n){var t=null,e=null,i=null,o=null;return n.forEach(function(n){switch(n.header.parameterCategory+","+n.header.parameterNumber){case"2,2":t=n;break;case"2,3":e=n;break;case"0,0":i=n;break;default:o=n}}),H(t,e,i)},_=function(n,u){t=J(n);var c=t.header;o=c.lo1,a=c.la1,r=c.dx,s=c.dy,l=c.nx,d=c.ny,i=new Date(c.refTime),i.setHours(i.getHours()+c.forecastTime),e=[];for(var h=0,p=Math.floor(l*r)>=360,m=0;m<d;m++){for(var f=[],v=0;v<l;v++,h++)f[v]=t.data(h);p&&f.push(f[0]),e[m]=f}u({date:i,interpolate:x})},x=function(n,i){var l,d=b(n-o,360)/r,u=(a-i)/s,c=Math.floor(d),h=c+1,p=Math.floor(u),m=p+1;if(l=e[p]){var f=l[c],v=l[h];if(L(f)&&L(v)&&(l=e[m])){var w=l[c],g=l[h];if(L(w)&&L(g))return t.interpolate(d-c,u-p,f,v,w,g)}}return null},L=function(n){return null!==n&&void 0!==n},b=function(n,t){return n-t*Math.floor(n/t)},C=function(){return/android|blackberry|iemobile|ipad|iphone|ipod|opera mini|webos/i.test(navigator.userAgent)},P=function(n,t,e,i,o,a,r,s){var l=r[0]*a,d=r[1]*a,u=z(n,t,e,i,o,s);return r[0]=u[0]*l+u[2]*d,r[1]=u[1]*l+u[3]*d,r},z=function(n,t,e,i,o,a){var r=2*Math.PI,s=Math.pow(10,-5.2),l=t<0?s:-s,d=e<0?s:-s,u=N(e,t+l,a),c=N(e+d,t,a),h=Math.cos(e/360*r);return[(u[0]-i)/l/h,(u[1]-o)/l/h,(c[0]-i)/d,(c[1]-o)/d]},D=function(n,t,e){function i(t,e){if(!n)return[NaN,NaN,null];var i=n[Math.round(t)];return i&&i[Math.round(e)]||y}i.release=function(){n=[]},i.randomize=function(n){var e,o,a=0;do e=Math.round(Math.floor(Math.random()*t.width)+t.x),o=Math.round(Math.floor(Math.random()*t.height)+t.y);while(null===i(e,o)[2]&&a++<30);return n.x=e,n.y=o,n},e(t,i)},T=function(n,t,e){var i=n[0],o=n[1],a=Math.round(i[0]),r=Math.max(Math.floor(i[1],0),0),s=(Math.min(Math.ceil(o[0],t),t-1),Math.min(Math.ceil(o[1],e),e-1));return{x:a,y:r,xMax:t,yMax:s,width:t,height:e}},O=function(n){return n/180*Math.PI},F=function(n){return n/(Math.PI/180)},A=function(n,t,e){var i=e.east-e.west,o=e.width/F(i)*360/(2*Math.PI),a=o/2*Math.log((1+Math.sin(e.south))/(1-Math.sin(e.south))),r=e.height+a,s=(r-t)/o,l=180/Math.PI*(2*Math.atan(Math.exp(s))-Math.PI/2),d=F(e.west)+n/e.width*F(i);return[d,l]},R=function(n){return Math.log(Math.tan(n/2+Math.PI/4))},N=function(n,t,e){var i=R(e.south),o=R(e.north),a=e.width/(e.east-e.west),r=e.height/(o-i),s=R(O(n)),l=(O(t)-e.west)*a,s=(o-s)*r;return[l,s]},I=function(n,t,e,i){function o(i){for(var o=[],r=t.y;r<=t.yMax;r+=2){var d=A(i,r,e);if(d){var u=d[0],c=d[1];if(isFinite(u)){var h=n.interpolate(u,c);h&&(h=P(a,u,c,i,r,s,h,e),o[r+1]=o[r]=h)}}}l[i+1]=l[i]=o}for(var a={},r=(e.south-e.north)*(e.west-e.east),s=h*Math.pow(r,.3),l=[],d=t.x;d<t.width;d+=2)o(d);D(l,t,i)},k=function(t,e,i){function o(n,t){var e=["rgb(36,104, 180)","rgb(60,157, 194)","rgb(128,205,193 )","rgb(151,218,168 )","rgb(198,231,181)","rgb(238,247,217)","rgb(255,238,159)","rgb(252,217,125)","rgb(255,182,100)","rgb(252,150,75)","rgb(250,112,52)","rgb(245,64,32)","rgb(237,45,28)","rgb(220,24,32)","rgb(180,0,35)"];return e.indexFor=function(i){return Math.max(0,Math.min(e.length-1,Math.round((i-n)/(t-n)*(e.length-1))))},e}function a(){l.forEach(function(n){n.length=0}),u.forEach(function(n){n.age>f&&(e.randomize(n).age=~~(Math.random()*f/2));var t=n.x,i=n.y,o=e(t,i),a=o[2];if(null===a)n.age=f;else{var r=t+o[0],d=i+o[1];null!==e(r,d)[0]?(n.xt=r,n.yt=d,l[s.indexFor(a)].push(n)):(n.x=r,n.y=d)}n.age+=1})}function r(){y.save(),y.globalAlpha=.16,y.globalCompositeOperation="destination-out",y.fillStyle="#000",y.fillRect(t.x,t.y,t.width,t.height),y.restore(),l.forEach(function(n,t){n.length>0&&(y.beginPath(),y.strokeStyle=s[t],n.forEach(function(n){y.moveTo(n.x,n.y),y.lineTo(n.xt,n.yt),n.x=n.xt,n.y=n.yt}),y.stroke())})}var s=o(p,m),l=s.map(function(){return[]}),d=(i.south-i.north)*(i.west-i.east),h=Math.round(t.width*t.height*w*Math.pow(d,.24));C()&&(h/=g),u=u||[],u.length>h&&(u=u.slice(0,h));for(var S=u.length;S<h;S++)u.push(e.randomize({age:~~(Math.random()*f)+0}));var y=n.canvas.getContext("2d");y.lineWidth=v;var M=Date.now();!function H(){c=requestAnimationFrame(H);var n=Date.now(),t=n-M;t>W&&(M=n-t%W,a(),r())}()},E=function(t,e,i,o,a){delete n.data,n.data=t,a&&U(e,i,o,a)},U=function(t,e,i,o){var a={south:O(o[0][1]),north:O(o[1][1]),east:O(o[1][0]),west:O(o[0][0]),width:e,height:i};q(),_(n.data,function(n){I(n,T(t,e,i),a,function(n,t){j.field=t,k(n,t,a)})})},q=function(){j.field&&j.field.release(),c&&cancelAnimationFrame(c)},$=function(t,e){var i=n.canvas,o=i.width,a=i.height,r=i.getContext("2d");if(o>t&&a>e){var s=function(n,t){return Math.max(0,Math.min(n,t))},l=r.getImageData(s(o,-t),s(a,-e),s(o,o-t),s(a,a-e));r.clearRect(0,0,o,a),r.putImageData(l,s(o,t),s(a,e));for(var d=0,c=u.length;d<c;d++)u[d].x+=t,u[d].y+=e}},j={params:n,start:U,stop:q,update:E,shift:$,createField:D,interpolatePoint:x};return j};window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(n){return window.setTimeout(n,1e3/FRAME_RATE)}}(),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(n){clearTimeout(n)}),L.Control.WindPosition=L.Control.extend({options:{position:"bottomleft",emptyString:"Unavailable"},onAdd:function(n){return this._container=L.DomUtil.create("div","leaflet-control-wind-position"),L.DomEvent.disableClickPropagation(this._container),n.on("mousemove",this._onMouseMove,this),this._container.innerHTML=this.options.emptyString,this._container},onRemove:function(n){n.off("mousemove",this._onMouseMove,this)},vectorToSpeed:function(n,t){var e=Math.sqrt(Math.pow(n,2)+Math.pow(t,2));return e},vectorToDegrees:function(n,t){var e=Math.sqrt(Math.pow(n,2)+Math.pow(t,2)),i=Math.atan2(n/e,t/e),o=180*i/Math.PI,a=o+180;return a.toFixed(3)},_onMouseMove:function(n){var t=this,e=WindJSHelper.map.containerPointToLatLng(L.point(n.containerPoint.x,n.containerPoint.y)),i=WindJSHelper.windy.interpolatePoint(e.lng,e.lat),o="";if(i&&!isNaN(i[0])&&!isNaN(i[1])&&i[2]){var a=i[1];a=a>0?a-=2*a:Math.abs(a),o="<strong>Wind Direction: </strong>"+t.vectorToDegrees(i[0],a)+"°, <strong>Wind Speed: </strong>"+t.vectorToSpeed(i[0],a).toFixed(1)+"m/s, <strong>Temp: </strong>"+(i[2]-273.15).toFixed(1)+"°C"}else o="no wind data";t._container.innerHTML=o,0==$(".leaflet-control-wind-position").index()&&$(".leaflet-control-wind-position").insertAfter(".leaflet-control-mouseposition")}}),L.Map.mergeOptions({positionControl:!1}),L.Map.addInitHook(function(){this.options.positionControl&&(this.positionControl=new L.Control.MousePosition,this.addControl(this.positionControl))}),L.control.windPosition=function(n){return new L.Control.WindPosition(n)};var WindJSHelper={map:null,data:null,options:null,canvasOverlay:null,windy:null,context:null,timer:null,mouseControl:null,init:function(n){this.map=n.map,this.options=n,n.map.on("overlayremove",function(n){n.layer==WindJSHelper.canvasOverlay&&WindJSHelper.destroyWind()})},getRequestUrl:function(){if(!WindJSHelper.options.useNearest)return WindJSHelper.options.latestUrl;var n={timeIso:WindJSHelper.options.timeISO||(new Date).toISOString(),searchLimit:WindJSHelper.options.nearestDaysLimit||7};return WindJSHelper.options.nearestUrl+$.param(n)},loadLocalData:function(){console.log("using local data.."),$.getJSON("demo.json",function(n){WindJSHelper.data=n,WindJSHelper.initWindy(n)})},loadWindData:function(){if(WindJSHelper.options.localMode)return void WindJSHelper.loadLocalData();var n=WindJSHelper.getRequestUrl();console.log(n),$.ajax({type:"GET",url:n,data:{format:"json"},error:function(n){console.log("error loading data"),WindJSHelper.options.errorCallback(n)||console.log(n),WindJSHelper.loadLocalData()},success:function(n){WindJSHelper.data=n,WindJSHelper.initWindy(n)}})},redraw:function(n,t){return WindJSHelper.windy?(WindJSHelper.timer&&clearTimeout(WindJSHelper.timer),void(WindJSHelper.timer=setTimeout(function(){var n=WindJSHelper.map.getBounds(),t=WindJSHelper.map.getSize();WindJSHelper.windy.start([[0,0],[t.x,t.y]],t.x,t.y,[[n._southWest.lng,n._southWest.lat],[n._northEast.lng,n._northEast.lat]])},750))):void WindJSHelper.loadWindData()},initWindy:function(n){console.log(n),WindJSHelper.windy=new Windy({canvas:WindJSHelper.canvasOverlay.canvas(),data:n}),WindJSHelper.context=WindJSHelper.canvasOverlay.canvas().getContext("2d"),WindJSHelper.canvasOverlay.canvas().classList.add("wind-overlay"),WindJSHelper.canvasOverlay.redraw(),WindJSHelper.map.on("dragstart",WindJSHelper.windy.stop),WindJSHelper.map.on("zoomstart",WindJSHelper.clearWind),WindJSHelper.map.on("resize",WindJSHelper.clearWind),this.initMouseHandler()},initMouseHandler:function(){!WindJSHelper.mouseControl&&WindJSHelper.options.displayValues&&(WindJSHelper.mouseControl=L.control.windPosition(WindJSHelper.displayOptions||{}).addTo(WindJSHelper.map))},clearWind:function(){WindJSHelper.windy&&WindJSHelper.windy.stop(),WindJSHelper.context&&WindJSHelper.context.clearRect(0,0,3e3,3e3)},destroyWind:function(){WindJSHelper.timer&&clearTimeout(WindJSHelper.timer),WindJSHelper.windy&&WindJSHelper.windy.stop(),WindJSHelper.context&&WindJSHelper.context.clearRect(0,0,3e3,3e3),WindJSHelper.mouseControl&&WindJSHelper.map.removeControl(WindJSHelper.mouseControl),WindJSHelper.mouseControl=null,WindJSHelper.windy=null,WindJSHelper.map.removeLayer(WindJSHelper.canvasOverlay)}};WindJSHelper.canvasOverlay=L.canvasOverlay().drawing(WindJSHelper.redraw);var WindJSLeaflet=function(n){function t(n){return new Promise(function(t,e){n.localMode&&t(!0),$.ajax({type:"GET",url:n.pingUrl,data:{format:"json"},error:function(n){e(n)},success:function(n){t(n)}})})}t(n).then(function(){console.log("check wind success"),WindJSHelper.init(n),n.layerControl.addOverlay(WindJSHelper.canvasOverlay,"wind")})["catch"](function(t){console.log("check wind failed.."),n.errorCallback(t)})};WindJSLeaflet.prototype.setTime=function(n){WindJSHelper.options.timeISO=n};